<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام توزيع المعونات</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #f4f4f4; padding: 20px; }
        #reader { width: 100%; max-width: 500px; margin: auto; border: 2px solid #333; border-radius: 10px; }
        #result { margin-top: 20px; padding: 15px; background: white; border-radius: 10px; display: none; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .data-field { font-size: 1.2em; margin: 10px 0; color: #333; }
        .data-label { font-weight: bold; color: #555; }
        select, button { padding: 12px; font-size: 1.1em; width: 100%; margin-top: 10px; border-radius: 5px; cursor: pointer; }
        button { background-color: #28a745; color: white; border: none; }
        button:disabled { background-color: #ccc; }
    </style>
</head>
<body>

    <h2>نظام تسجيل تسليم المعونات</h2>
    <div id="reader"></div>

    <div id="result">
        <div class="data-field"><span class="data-label">الاسم: </span><span id="res-name"></span></div>
        <div class="data-field"><span class="data-label">الرقم القومي: </span><span id="res-id"></span></div>
        <div class="data-field"><span class="data-label">العنوان: </span><span id="res-address"></span></div>
        
        <hr>
        <label>نوع المعونة:</label>
        <select id="aidType">
            <option value="كرتونة مواد غذائية">كرتونة مواد غذائية</option>
            <option value="لحوم">لحوم</option>
            <option value="معونة نقدية">معونة نقدية</option>
            <option value="أخرى">أخرى</option>
        </select>
        
        <button id="submitBtn" onclick="submitDelivery()">تأكيد التسليم</button>
        <p id="msg"></p>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzNQFqyXxTH56GbxxAV4HfYXXkkq9X6BA2-XNTJ6dGfP3uPZ3Vay9c2rNKWCtpvMTe5vw/exec';
        let currentID = "";

        function onScanSuccess(decodedText) {
            // استخراج الرقم القومي من الرابط الممسوح
            try {
                const url = new URL(decodedText);
                currentID = url.searchParams.get("id");
                
                if (currentID) {
                    fetchData(currentID);
                }
            } catch (e) {
                alert("كود غير صالح");
            }
        }

        function fetchData(id) {
            document.getElementById('msg').innerText = "جاري جلب البيانات...";
            fetch(`${scriptURL}?id=${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data !== "Not Found") {
                        document.getElementById('result').style.display = 'block';
                        document.getElementById('res-name').innerText = data[1]; // الاسم في العمود الثاني
                        document.getElementById('res-id').innerText = data[2];   // الرقم القومي في الثالث
                        document.getElementById('res-address').innerText = data[5]; // العنوان في السادس
                        document.getElementById('msg').innerText = "";
                    } else {
                        alert("المواطن غير مسجل بالنظام");
                    }
                });
        }

        function submitDelivery() {
            const btn = document.getElementById('submitBtn');
            const aid = document.getElementById('aidType').value;
            btn.disabled = true;
            document.getElementById('msg').innerText = "جاري التسجيل...";

            fetch(scriptURL, {
                method: 'POST',
                body: JSON.stringify({ id: currentID, aidType: aid })
            })
            .then(res => res.text())
            .then(response => {
                if (response === "Success") {
                    alert("تم تسجيل التسليم بنجاح!");
                    location.reload();
                }
            })
            .catch(error => {
                alert("حدث خطأ في الاتصال");
                btn.disabled = false;
            });
        }

        let html5QrcodeScanner = new html5I2cScanner("reader", { fps: 10, qrbox: 250 });
        html5QrcodeScanner.render(onScanSuccess);
    </script>
</body>
</html>
