<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¹ÙˆÙ†Ø§Øª</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; text-align: center; background-color: #f8f9fa; padding: 20px; margin: 0; color: #333; }
        h2 { color: #1a73e8; margin-bottom: 25px; font-weight: 700; }
        
        /* Ø¥Ø·Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
        #reader { width: 100%; max-width: 450px; margin: 0 auto; border: none; border-radius: 25px; overflow: hidden; background: #000; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; }
        
        /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
        #result { margin-top: 25px; padding: 25px; background: white; border-radius: 20px; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: right; max-width: 450px; margin-left: auto; margin-right: auto; border-top: 6px solid #28a745; }
        
        .info { font-size: 1.1em; margin-bottom: 15px; border-bottom: 1px solid #f1f1f1; padding-bottom: 10px; }
        .label { font-weight: 700; color: #5f6368; margin-left: 8px; }
        
        select { width: 100%; padding: 14px; margin-top: 10px; border-radius: 12px; font-size: 1em; border: 2px solid #e0e0e0; outline: none; transition: 0.3s; }
        select:focus { border-color: #1a73e8; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø·ÙˆØ±Ø© */
        .btn { 
            width: 100%; padding: 16px; margin-top: 20px; border-radius: 15px; font-size: 1.1em; font-weight: 600; 
            cursor: pointer; transition: 0.3s; border: none; display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        #submitBtn { background-color: #28a745; color: white; }
        #submitBtn:hover { background-color: #218838; transform: translateY(-2px); }
        
        #startBtn { background-color: #1a73e8; color: white; margin-bottom: 20px; max-width: 450px; margin-left: auto; margin-right: auto; }

        #msg { margin-top: 20px; font-weight: 600; color: #d93025; }
    </style>
</head>
<body>

    <h2>Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹ÙˆÙ†Ø§Øª</h2>

    <button id="startBtn" class="btn" onclick="startCamera()">ğŸ“· ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ©</button>
    
    <div id="reader"></div>

    <div id="result">
        <div class="info"><span class="label">Ø§Ù„Ø§Ø³Ù…:</span> <span id="res-name"></span></div>
        <div class="info"><span class="label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ:</span> <span id="res-id"></span></div>
        <div class="info"><span class="label">Ø§Ù„Ø¬Ù‡Ø©:</span> <span id="res-org"></span></div>
        <div class="info"><span class="label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</span> <span id="res-region"></span></div>
        <div class="info"><span class="label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©/Ø§Ù„Ø­ÙŠ:</span> <span id="res-district"></span></div>
        
        <div style="text-align: right; margin-top: 15px;">
            <label class="label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹ÙˆÙ†Ø©:</label>
            <select id="aidType">
                <option value="ÙƒØ±ØªÙˆÙ†Ø© Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©">ğŸ“¦ ÙƒØ±ØªÙˆÙ†Ø© Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©</option>
                <option value="Ù„Ø­ÙˆÙ…">ğŸ¥© Ù„Ø­ÙˆÙ…</option>
                <option value="Ù…Ø¹ÙˆÙ†Ø© Ù†Ù‚Ø¯ÙŠØ©">ğŸ’° Ù…Ø¹ÙˆÙ†Ø© Ù†Ù‚Ø¯ÙŠØ©</option>
                <option value="Ø£Ø®Ø±Ù‰">âœ¨ Ø£Ø®Ø±Ù‰</option>
            </select>
        </div>
        
        <button id="submitBtn" class="btn" onclick="submitDelivery()">âœ… ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
        <div id="msg"></div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzNQFqyXxTH56GbxxAV4HfYXXkkq9X6BA2-XNTJ6dGfP3uPZ3Vay9c2rNKWCtpvMTe5vw/exec';
        let currentID = "";
        const html5QrCode = new Html5Qrcode("reader");

        function startCamera() {
            document.getElementById('startBtn').style.display = 'none';
            
            // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ: Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ© (environment) ÙˆØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start(
                { facingMode: "environment" }, 
                config, 
                onScanSuccess
            ).catch(err => {
                alert("Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ©ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„Ø¥Ø°Ù†.");
                document.getElementById('startBtn').style.display = 'block';
            });
        }

        function onScanSuccess(decodedText) {
            html5QrCode.stop(); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
            try {
                const url = new URL(decodedText);
                currentID = url.searchParams.get("id");
                if (currentID) { fetchData(currentID); }
            } catch (e) { 
                alert("ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­");
                startCamera(); 
            }
        }

        function fetchData(id) {
            document.getElementById('msg').innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";
            fetch(`${scriptURL}?id=${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data !== "Not Found") {
                        document.getElementById('result').style.display = 'block';
                        document.getElementById('res-name').innerText = data[1] || "â€”";
                        document.getElementById('res-id').innerText = data[2] || "â€”";
                        document.getElementById('res-org').innerText = data[12] || "â€”";
                        document.getElementById('res-region').innerText = data[5] || "â€”";
                        document.getElementById('res-district').innerText = data[6] || "â€”";
                        document.getElementById('msg').innerText = "";
                    } else {
                        alert("Ø§Ù„Ù…ÙˆØ§Ø·Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„");
                        location.reload();
                    }
                });
        }

        function submitDelivery() {
            const btn = document.getElementById('submitBtn');
            const aid = document.getElementById('aidType').value;
            btn.disabled = true;
            document.getElementById('msg').innerText = "ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";
            fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ id: currentID, aidType: aid }) })
            .then(() => {
                alert("ğŸŠ ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
                location.reload();
            });
        }
    </script>
</body>
</html>
