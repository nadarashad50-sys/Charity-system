<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام توزيع المعونات</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background-color: #f0f2f5; padding: 20px; margin: 0; }
        h2 { color: #1a73e8; margin-bottom: 20px; }
        #reader { width: 100%; max-width: 450px; margin: 0 auto; border: 4px solid #28a745; border-radius: 15px; overflow: hidden; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #result { margin-top: 20px; padding: 20px; background: white; border-radius: 12px; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: right; max-width: 450px; margin-left: auto; margin-right: auto; }
        .info { font-size: 1.1em; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .label { font-weight: bold; color: #2c3e50; margin-left: 5px; }
        select, button { width: 100%; padding: 15px; margin-top: 15px; border-radius: 8px; font-size: 1em; border: 1px solid #ccc; }
        button { background-color: #28a745; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background-color: #218838; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #msg { margin-top: 15px; font-weight: bold; color: #d9534f; }
        /* تحسين مظهر أزرار الكاميرا في الأيفون */
        #reader button { padding: 10px; margin: 5px; border-radius: 5px; border: 1px solid #ccc; background: #fff; }
    </style>
</head>
<body>

    <h2>نظام تسجيل تسليم المعونات</h2>
    
    <div id="reader"></div>

    <div id="result">
        <div class="info"><span class="label">الاسم:</span> <span id="res-name"></span></div>
        <div class="info"><span class="label">الرقم القومي:</span> <span id="res-id"></span></div>
        
        <label class="label" for="aidType">نوع المعونة:</label>
        <select id="aidType">
            <option value="كرتونة مواد غذائية">كرتونة مواد غذائية</option>
            <option value="لحوم">لحوم</option>
            <option value="معونة نقدية">معونة نقدية</option>
            <option value="أخرى">أخرى</option>
        </select>
        
        <button id="submitBtn" onclick="submitDelivery()">تأكيد عملية التسليم</button>
        <div id="msg"></div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzNQFqyXxTH56GbxxAV4HfYXXkkq9X6BA2-XNTJ6dGfP3uPZ3Vay9c2rNKWCtpvMTe5vw/exec';
        let currentID = "";

        function onScanSuccess(decodedText) {
            console.log("تم مسح الكود: " + decodedText);
            try {
                const url = new URL(decodedText);
                currentID = url.searchParams.get("id");
                
                if (currentID) {
                    fetchData(currentID);
                } else {
                    alert("الكود الممسوح لا يحتوي على رقم قومي صحيح.");
                }
            } catch (e) {
                alert("تنبيه: الكود الممسوح ليس رابطاً صحيحاً للنظام.");
            }
        }

        function fetchData(id) {
            document.getElementById('msg').innerText = "جاري جلب بيانات المواطن...";
            fetch(`${scriptURL}?id=${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data !== "Not Found") {
                        document.getElementById('result').style.display = 'block';
                        document.getElementById('res-name').innerText = data[1];
                        document.getElementById('res-id').innerText = data[2];
                        document.getElementById('msg').innerText = "";
                    } else {
                        alert("عفواً، هذا المواطن غير مسجل في قاعدة البيانات.");
                        document.getElementById('msg').innerText = "";
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("خطأ في الاتصال بقاعدة البيانات.");
                });
        }

        function submitDelivery() {
            const btn = document.getElementById('submitBtn');
            const aid = document.getElementById('aidType').value;
            
            btn.disabled = true;
            document.getElementById('msg').innerText = "جاري تسجيل التسليم في النظام...";

            fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ id: currentID, aidType: aid })
            })
            .then(() => {
                alert("تم تسجيل التسليم بنجاح في شيت جوجل!");
                location.reload();
            })
            .catch(error => {
                alert("حدث خطأ أثناء التسجيل.");
                btn.disabled = false;
                document.getElementById('msg').innerText = "";
            });
        }

        // التعديلات الجديدة هنا لضبط الكاميرا الخلفية والأيفون
        var html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", 
            { 
                fps: 10, 
                qrbox: 250,
                // إجبار النظام على محاولة استخدام الكاميرا الخلفية أولاً
                videoConstraints: { facingMode: { exact: "environment" } } 
            }
        );

        // دالة للتعامل مع أخطاء الأيفون (Safari)
        function startScanner() {
            html5QrcodeScanner.render(onScanSuccess, (errorMessage) => {
                // إذا فشل في فتح الكاميرا الخلفية (كما في بعض إصدارات أيفون)، نحاول فتح الكاميرا المتاحة
                if (errorMessage.includes("OverconstrainedError")) {
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
                    html5QrcodeScanner.render(onScanSuccess);
                }
            });
        }

        startScanner();
    </script>
</body>
</html>
